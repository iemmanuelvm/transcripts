I can imagine that you have bittersweet feelings about being at the end of this section of the course

time frequency analysis, because I'm sure you loved this section so much, you're a little bit upset

that it's over.

But on the other hand, you're probably super excited to get to the next section of the course, which

is all about connectivity, analyses, synchronization and so forth.

Fortunately for you, there is one more big project to work on.

This is another opportunity for you to improve your skills at signal processing time, frequency analysis

and matlab coding.

So there are six problems in this problem.

Set six different exercises in this video.

I'm going to work through the solutions for the first three and then I'll do the next three in the next

video.

And of course, you know, by this point in the course that what you should do if you haven't already

is stop this video and work through all this code yourself, see how far you can get, and then you

can come back and watch me go through the solution.

All right.

Without further ado, let's dive right in to number one power and phase from the famous trial ten.

I don't know why this trial is famous, but let's just pretend it is otherwise.

Trial Ten is going to start getting a little bit upset.

OK, so what we want to do is create a family of complex Morleigh wavelets from ten to one hundred hertz

in forty three linearly spaced steps for convolution from trial.

Ten for all channels.

Extract power and phase and store the results.

OK, and then I assume we're going to do some visualization later.

So let's see here we are loading in the data.

We specify the frequency range from ten to one hundred hertz in point one steps.

That's not even a sensible result.

That should be forty three according to the instructions.

So let's see now we specify the wavelet and now notice this wavelet actually starts at minus two hundred

seconds and goes up to two seconds.

So this is not good.

We are going to have a huge phase shift in the wavelet.

The wavelet is going to be all the way shifted to the right side of the Time series, and that will

introduce a phase shift of one hundred and ninety eight seconds in the actual data hour in the results

of convolution.

So we want this to be more or less symmetric.

Now, I want to mention something about taking, you know, knocking off one sample point here.

The thing is that this data set for some reason has this bizarre sampling rate of seven hundred and

sixty two point nine three nine five.

So if you go with this sampling rate, if you go from minus two to plus two, you actually end up with

a time vector.

For the wavelet convolution, that is an even number of points.

And that means that there is no actual center, there's no true center to this way of time.

Now that on its own isn't so much of a problem in general.

The procedure in convolution is that if you have a kernel with an even length, then you would specify

that the center of the kernel is the middle point plus point five.

So you would basically round up.

However, when you get down to this stuff like computing half the length of the wavelet and chopping

off the wings, it's going to get you're going to have a bit of a headache here.

So it's in general a better idea to have the wavelet time be an odd number of data points that will

save you headaches for later on in convolution.

Now, I have shown you in this course two ways of getting this to be an even and odd number of points

that's also centered.

So one way is what I'm doing here, where I'm just subtracting off one sample point and now you can

see that it's three thousand fifty one point long.

So that's odd.

Now it is maybe slightly a tiny bit awkward because we have the first and the last point are not exactly

the same.

They're not exactly mirrored on both sides of zero.

But in my opinion, this is really not a big deal.

This is one tiny, tiny little sample point off.

So it's not really going to have any practical implications a second way.

So I mentioned there's two ways that that I've shown you on this course for setting us up a second way

would be to do something like this where you would go, let's say you go from like zero to four.

And then actually that we still need to to subtract off simple point, so let's say you go zero to four

minus one sample point.

So that gives you an odd number of points.

Now, this is not centered.

We need it to be centered.

So then you could say we have time equals life time minus mean lifetime.

So you might remember I've shown you this code before as well.

So now this is a little bit more interesting.

It's it's going to be centered.

However, now there's not going to be an exact zero point.

So the thing is, yeah, either way, it's a little bit awkward and this just happens from having a

kind of weird sampling rate.

All right.

Anyway, now that I've written this code, I think I will just leave it like this.

Let's see.

So here's the vector of frequencies there, linearly spaced from ten to one hundred in forty three steps.

So that part all looks good.

And plus and minus one, that part looks good as well.

And data.

Notice this is just the length of time that we're not multiplying by the number of trials because we

are only working with one trial, the famous trial ten.

OK, and then here we specify the number of cycles.

So it looks like we're using the cycles formulation of the Gaussian.

And then here's a loop where we are creating the complex Morleigh Wavelets.

So we initialize this to Frequency's by Will.

Also Frequency's, as it turns out.

But this is Frequency's of the Wavelet.

This is frequencies from the 48 transform.

So let's see.

Here is our complex Morleigh Wavelet E to the I to pi F.T. Times the Gaussian eat the minus T squared

over two square.

So now we need to define this two squared.

So this is just s in here.

But of course we need to define s.

So as you remember from the video we talked about the width of the Gaussian, the shape of the Gaussian,

that is the number of cycles.

So nums like and then it's the fifth element divided by the normalization factor which was two times

PI times F, and that is Frex F I.

OK, so what I want to do is run this.

I just wrote some code.

I want to make sure that I've actually written correct code.

So I'm going to start by creating this complex Morleigh wavelet here and then I'm going to plot it.

So plot we have time and we can just plot the real part and OK, that looks pretty good.

Looks like a wavelet.

And here we have at the lowest frequency of the first frequency, we have three cycles.

So to be honest, three cycles at ten hertz feels a little bit on the small side, but that's OK.

I also know with this data set, we are mostly interested in the gamma band activity in generally,

you know, like 30 to 60 hertz.

So I think it's OK.

All right.

So that part looks good.

And then let's see.

So here we do.

We take the F 50 of the complex, multi wavelet.

It's the end point FFT and then we max value normalize.

All right.

This all looks good.

OK, so now here we are going to do convolution and we are initializing the time, frequency matrix,

so we have channels that's the first dimension by frequencies, by time by 2:00.

And this little to at the end is for power and phase.

So let's see, we're looping over channels and then we compute the four year coefficients of the data.

Hmm.

But I'm looking at this very carefully, and I see that this is not exactly correct.

We have the CFD data for this channel all the time, points in all trials.

But that's wrong.

We only want from one trial.

This is the variable.

Which trial?

Let's see which trial.

OK, so.

From this and this, and this is a vector, and that's what I expect.

OK, so that's good.

Let's see now we loop over frequencies and second and third steps of convolution.

I already see a little mistake here.

So it's the inverse FFE of the spectrum of the wavelet times, the spectrum of the data not divided

by.

And then we trim down the wavelets.

So let's see.

Oh yeah.

OK then we need to extract power and phase.

Let's see.

So this is T.F. And then we want Channe I and then so the first dimension is channel, the second dimension

is frequency.

So that's F.I..

The third dimension is time and time is coming from this variable A-s.

So we want all time points and then we want one for power.

So then we get ABSs s and squared OK.

And then here channel GFI all time points and two here.

This is going to be the angle of a US, so that's going to give us power and phase.

Let's see, see if I can run all of this and cool down pretty quickly.

All right.

So plotting the results, part one is going to be a multipart results, plotting exercise, time, frequency.

So, uh, plot, time, frequency, power and phase from electrodynamics.

So here we have electrodes six and here we are plotting power and that says power.

And here we are plotting phase and that says phase.

OK, so let's have a look at this.

All right, so here we see the that's actually pretty interesting that you remember what the the trial

average result looks like and it's actually pretty similar to this.

So there is like this lower frequency gamma response than here.

There's this higher frequency gamma response that decreased in frequency over time.

So pretty interesting that what you see at trial 10 also is pretty representative of what you see over

the entire the trial average.

Here you see the phase values.

These look totally wild.

This is like from some wacky 1970s sci fi movie or something.

OK, let's see what we can do about these questions.

Can you use the same color scaling for the two plots?

Why or why not?

So let's have a look at these color scales here.

So this figure here, the power is on a color scale from zero to 80000.

And here we have a color scale from minus Pi to plus pi.

So the answer is no, you cannot use the same color scaling, or at least it doesn't make sense to use

the same color scaling on both plots because power and phase are just totally different.

Quantities are generally on totally different scales.

Now, that said, if you have a decimal normalized power, then a scale from minus PI to plus by actually

could make sense because that's minus three to plus three and that tends to be a respectable range for

brain activity change from baseline in decibels.

But I think the point of this question is just to remind you that power and phase are totally different

quantities from each other.

So they would in general need a different color, scaling their different physical units, different

interpretations and so on.

OK, so let's have a look.

Plotting the results part to depth by time.

So we want to make for layer by time maps and layer here refers to the cortical layer that the electrode

is going through the cortex.

So we have different layers of the cortex in different electrodes.

So let's see, we want power on top and Fais on the bottom from 40 hertz and 55 hertz.

All right.

So what I think we are supposed to do here is use the Min abs procedure to find the index in the frequency

vector that is as close as possible to forty and fifty five hertz.

So you could have also solved it like this.

You know, you could have used search.

And I use that function sometimes, but it's also useful to be able to use this min abs thing.

And I think I've introduced this previously in the course.

So let's say we want to do the way this works.

As you say, the vector that you are searching through, minus the number that you are looking for and

what the second output of of MIN will return is the index into this vector that is as close as possible

to this vector or this data point, this value.

So we can say so the answer was 15.

So Frex 15 is exactly 40 hertz.

So that works out pretty well.

OK, so here then we just want to say Frex minus 55 and so that happens to be 22.

So I'm going to type Frex Hertz's and we get forty and fifty five.

Very nice.

All right.

So now we do some plotting and I don't see anything immediately missing.

So let's run.

OK.

So there is something missing.

OK, so let's have a look at this.

So we are running contour f here.

We specify the x axis values, the y axis values, which is just the channel indices and then the Z

axis values.

But here I'm actually inputting a four dimensional matrix and Matlab is saying the input I must have

at most two dimensions.

So let's have a look at this thing.

So we want to plot what do we want to plot here?

Well, it's going to be all of the channels and then this is the frequencies.

Now, we don't want to plot all frequencies.

We want to plot only the frequency or only one frequency.

And this is the ith frequency.

So this loop is going over frequencies.

You can also see that by looking here.

So the ith frequency or the hertz is frequency and then we want all time points and this one is supposed

to be power.

And I know that it's power because it says that in the title.

Now I'm going to run this.

I think we might need to squeeze this thing here.

Yeah, OK, so we need to squeeze, squeeze, squeeze, squeeze when in doubt squeeze.

Let's try this.

OK, there you go.

Very nice.

So and then this is going to be so I'm going to copy and paste here because this is basically the same

code.

We're just putting phase values instead of power values.

Oh right.

Let's see.

So let's get down to this, these questions here, how can you interpret the phrase plots?

Well, the phase plots are difficult to interpret.

These are the absolute phase values and they're coming from some fairly high frequency.

So these are modulating pretty pretty quickly, actually.

So the raw phase values themselves tend to be really difficult or maybe impossible to interpret with

these kinds of data.

Mostly what you're interested in with the phase values is looking at the consistency of phase out values

within a channel over different trials or between two different channels.

That would be phase synchronization, which you will learn about in the next section.

So I think these phase values are mostly pretty difficult to interpret.

And then how do you so the second question, how do you interpret the two power plots?

So you have to be careful here.

Remember, in the beginning of the course, in the introduction section, I talked about the five step

plan for interpreting time frequency plots.

And one of those steps was to figure out what you're even looking at, what is going on with the axes.

So here this is time.

This is not frequency.

This is depth into the cortex.

These are lower sights, deeper in the cortex and more superficial in the cortex.

And so this is not frequency.

So this entire map is what you see at 40 hertz.

And what you're looking at here is like a slice through visual cortex over time.

So what you see in particular comparing this map to this map is that the first visual stimulus which

appeared at time zero that had a really big response at 40 hertz that was mostly in these middle layers.

This turns out to be around layer four of the cortex, but that part doesn't matter.

But you see that there's this lower frequency gamma early and then it spreads a little bit later in

time to deeper layers of visual cortex.

And then at 55 hertz, at a higher gamma, you see basically no activity, maybe a tiny little blip

here, but very little high frequency activity.

And here you see a lot more high frequency activity for the second stimulus.

Cool.

So that was fun.

That was a pretty interesting exercise.

And now I'm going to move on to exercise, too, which is working with the same data set, but now using

the data from all trials, not only trial 10.

All right.

And then instead of the raw phases, we want to compute the PC and show the same plots that we just

showed above.

All right.

So here's an interesting question.

Which parameters or variables do we need to recompute and which can we reuse from above so we can just

think about that?

Well, we already have some hints here.

So the length of convolution has to change because now we are using all of the trials.

So the data.

So the end of the data is going to be time by trials and not just time.

So on the one hand, it means that we don't need to recreate the complex Morleigh Wavelets in the time

domain.

However, we didn't actually save any of the time domain wavelet.

So if we had saved these in a matrix, then we wouldn't need to recompute it again.

But we do need to recompute the four transform of the wavelets because the end of convolution is different.

OK, but anyway, it does mean that we need to rerun recreate these wavelet.

So let's see here we have this is already done for us and OK, so here we do two squares.

It's two times s which is the number of cycles normalized by two pi f squared.

And then here we have our wavelet so e to the I 250 times E to the minus T squared divided by one S

squared.

That's wrong.

This is supposed to be two squared.

What a strange mistake in the code.

OK, and then take the FFE and normalize by the max value.

OK, very good.

Let's run all of this code here.

Oops.

OK, so it looks like we're getting an error with zeros and I guess that's coming from this line.

So this is fine.

And here we see.

So let's see.

So we are trying to get we are trying to create a Xeros matrix that is 43 by.

Oh that's funny.

And conv is.

I see.

So income is a vector, which it's not supposed to be.

It's just supposed to be a single number.

So what's going on here?

I didn't even notice this at first.

I wonder if you caught this mistake before I did is we are multiplying NP data.

So the length of the time vector and here this is just times the size of sixty.

But this actually gives us three numbers back corresponding to the three dimensions of the CFD matrix.

And we only care about the third dimension.

OK, that's pretty funny.

Let's see.

All right, this looks better, and now let's create all of these wavelets.

Or at least the specter of all these wavelets, initialise the time frequency output matrix are here.

We have channels by frequency's, by time by two, and that's going to be for power and phase.

So let's see.

I solved this loop using I solved this problem using no loop over channels by taking advantage of the

Matrix input into the FFG function.

OK, so what are we talking about up here?

Let's have a look down here and see what's going on.

So here we are looping over frequencies, creating or implementing convolution.

The meat of convolution.

Here is the inverse Fourier transform of the EEG data or the spectrum of the data times, the complex,

more wavelet spectrum that is replicated so that it's repeated according to the number of channels.

So that means that this has to be a matrix is going to be channels by frequency.

This is actually the variable from the previous cell, the previous problem set where we were doing

this with one channel.

OK, so what we need here is a matrix.

Let's call this EEG X, and this has to be the 48 transform of the CFD data.

And now the CSC data is three dimensional.

We need this to be a channel by Time Trials matrix.

So I'm going to reshape this to be caused by 16 and I'll softcore that to be size sixty one by basically

NT data.

OK, so let's have a look at the size of this thing to confirm.

Right, so this is 16 by three hundred thousand, so this is super trials and then we have sixteen channels.

So now we want to do is we have to make sure that we are computing the FFE over the proper dimensions.

So I'm going to open up this FFE function again so I can make sure that I'm getting the second and third

input in the correct order.

So the second input is the end of the first and the third input is the dimension along which to compute

the 50.

So for the end of the 50 is NP con and now we have to think about which dimension we want to compute

the Fourier transform over if we do this.

Oops, I'm going to that.

If we do this with saying to do the 50 over the first dimension, what that's actually doing is computing

a special for transform over channels separately at each time point.

Now that is technically a legal operation, but it is not very sensible.

It's not what we want.

We want the foyer transform over time.

So that's the second dimension.

All right, very good.

And then, yeah, so this is just a note saying I wanted to explicitly have this in the problems that

so you can see how this works with a matrix input into the function.

It's not that it's a terrible thing.

It's that it can get confusing so it can increase the risk of mistakes and it can Fullan, just crash.

If you have tons of channels, let's say you have 200 channels and a lot of data, you're probably just

going to run out of memory and Matlab won't even be able to store or compute all the matrices needed

to implement the 50, OK?

Nonetheless, it's going to work here.

So let's see.

Here we are computing.

So actually let's let's run this.

So here we say as is three thousand eight.

So you can see it's bigger than the original data matrix.

So we need to cut off the wings.

And that's yeah, it's really important to keep this part in mind.

So we are cutting off the wings for all of the frequency spectra separately for each channel.

That's pretty important.

So and then we resize back to the original data shape.

So then it ends up being channels by time, by trials.

And then here we are.

So let's see, we are extracting the information for all channels, this frequency all time points and

power.

And that is mean of abs squared are abs, abs, abs, a little confusing here and then average over

the third dimension, which is trials.

So this part is correct.

That should run.

Yep.

And then here we have the oil reraised phase angle so e to the eye phase angles and then we average

over the third dimension again over trials and then we take the length of that average vector.

OK, so this all looks legit.

And it runs in only a matter of seconds and probably what takes the longest in this whole loop is this

bit here, I'm guessing anyway, but it did do the wavelet convolution over all channels and all frequencies.

And so we end up with these pretty big matrices.

OK, now for plotting and let's just run through this and see if this will work.

Figure for.

OK, so we got a figure for.

That's good.

So here we have power from Trial 10 and contact six.

I believe that that is incorrect.

That should say.

Whereas the title.

The title is Power from All Trials.

We are averaging over trials and here this is phase.

This is actually now it PC from well, it's not necessarily from all trials at contact six.

So let's try running this again with proper titles.

OK, I guess I probably should have made this plural all trials, not trial, but that's OK.

Otherwise this looks pretty good.

Here we see it.

And again, it's interesting to see this dissociation between power and phase locking dynamics where

you see some phase clustering here in these low frequencies without any power or very, very little

power, I guess.

And conversely, here you get these changes in power with really nothing happening in phase, maybe

a little bit of phase reset you see here corresponding to this, a little bit of this gamma burst here.

All right.

So it's just another illustration that what's happening with the, uh, with the power, which is mostly

non phase locked in this case because there's very little ETPs.

So what happens in the power dynamics and what happens in phase dynamics can be very, very different

from each other.

Sometimes power and phase show similar qualitative patterns and sometimes they show totally different

qualitative patterns.

OK, so let's see here we are making another Contar plot and figure five.

And this is going to be oh yeah, this is the depth by time plots for the two frequencies.

So let's run this and see how that looks.

Oops.

And we get a case.

There's something wrong with the Y label.

Let's see.

That is, uh, look at that.

The Y label is just blank.

We need to insert a Y label.

So what is the Y label.

Well it's actually just the channels.

So channels I'll say depth.

Just as a reminder in this data set channels is the same thing as depth in the cortex.

So let's see, let's try running all this again and here we get our results.

So now it's pretty interesting to well, I closed that other figure to save some space here.

But if you still have that other figure from Trial Ten, then it's interesting to compare this trial

with what you saw in, uh, Trial Ten to see how representative Trial Ten is for all of the two hundred

trials averaged together.

And actually, I think that was pretty representative.

You remember at forty hertz we saw this early burst here, which wasn't really present at fifty five

hertz, and we had a stronger response at fifty five hertz to the second stimulus compared to the first

stimulus.

Now back there with trial ten, we couldn't really interpret the phase values, but here we can because

these are not just the phases, these are ETPs.

So what's the consistency of the phase angle time series over time?

And it's pretty interesting that you see that there's some phase locking here that goes through some

parts of the cortex, so maybe two thirds of the cortex.

And then there's the superficial layers of the cortex up here where there really is no phase locking.

All right.

So that was pretty cool.

I hope you enjoyed working on this first problem said.

And actually, I'm looking at the timer and I see now has been around half an hour, so I think I'll

actually stop the video now and continue with the second exercise in the next video.

So go have a short break and come back and we will continue working through this problem set.

